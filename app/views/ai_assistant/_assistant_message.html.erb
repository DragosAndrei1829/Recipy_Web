<div class="ai-message ai-message-assistant flex justify-start">
  <div class="max-w-[85%] bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-bl-md px-4 py-3 shadow-sm">
    <% if response.is_a?(Hash) %>
      <!-- AI Response with structured data -->
      <div class="space-y-4">
        <!-- Provider Badge -->
        <% if response["ai_provider"] %>
          <div class="flex items-center gap-2">
            <span class="text-xs px-2 py-0.5 rounded-full <%= response['ai_provider'] == 'local' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700' %>">
              <%= case response["ai_provider"]
                  when 'local' then 'ğŸ” CÄƒutare localÄƒ'
                  when 'openai' then 'âœ¨ Generat cu OpenAI'
                  else 'ğŸ” CÄƒutare localÄƒ'
                  end %>
            </span>
          </div>
        <% end %>
        
        <!-- Main Message -->
        <% if response["message"].present? %>
          <p class="text-gray-800 dark:text-gray-200 text-sm leading-relaxed whitespace-pre-line">
            <%= response["message"].gsub(/\*\*(.+?)\*\*/, '<strong>\1</strong>').html_safe %>
          </p>
        <% end %>
        
        <% case response["type"] %>
        <% when "recommendation" %>
          <!-- Recipe Recommendations -->
          <% if response["matching_recipes"].present? %>
            <div class="mt-4 space-y-3">
              <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">ReÈ›ete gÄƒsite Ã®n comunitate</p>
              <% response["matching_recipes"].each_with_index do |recipe, index| %>
                <% next if recipe["id"].nil? %>
                <div class="bg-white dark:bg-gray-600 rounded-xl p-3 border border-gray-200 dark:border-gray-500 hover:shadow-md transition-shadow">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <h4 class="font-medium text-gray-800 dark:text-white text-sm">
                        <%= link_to recipe["title"], recipe_path(recipe["id"], locale: I18n.locale), class: "hover:text-emerald-600 transition-colors" %>
                      </h4>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        de <%= recipe["user"] %> â€¢ 
                        <span class="text-emerald-600 font-medium"><%= recipe["match_percentage"] %>% potrivire</span>
                      </p>
                    </div>
                    <span class="px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 rounded-lg text-xs font-medium">
                      #<%= index + 1 %>
                    </span>
                  </div>
                  
                  <div class="mt-2 flex flex-wrap gap-2 text-xs">
                    <span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-500 rounded text-gray-600 dark:text-gray-300">
                      â±ï¸ <%= recipe["time_to_make"] %> min
                    </span>
                    <span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-500 rounded text-gray-600 dark:text-gray-300">
                      ğŸ“Š Dificultate: <%= recipe["difficulty"] %>/5
                    </span>
                    <span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-500 rounded text-gray-600 dark:text-gray-300">
                      â¤ï¸ <%= recipe["likes_count"] %> aprecieri
                    </span>
                  </div>
                  
                  <% if recipe["missing_ingredients"].present? && recipe["missing_ingredients"].any? %>
                    <div class="mt-2 text-xs text-orange-600 dark:text-orange-400">
                      âš ï¸ Ingrediente lipsÄƒ: <%= recipe["missing_ingredients"].first(3).join(", ") %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
          
        <% when "no_match" %>
          <!-- No matches found - offer AI generation -->
          <% if response["can_generate"] %>
            <div class="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border border-blue-200 dark:border-blue-700">
              <p class="text-sm font-medium text-blue-800 dark:text-blue-300 mb-3">ğŸ¤– Vrei sÄƒ generez o reÈ›etÄƒ cu ChatGPT?</p>
              <div class="flex flex-wrap gap-2">
                <% if current_user&.has_pro_subscription? && ENV["OPENAI_API_KEY"].present? %>
                  <button type="button" 
                          class="generate-ai-btn px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"
                          data-provider="openai"
                          data-ingredients='<%= response["ingredients"].to_json %>'>
                    âœ¨ GenereazÄƒ cu ChatGPT (PRO)
                  </button>
                <% elsif !current_user&.has_pro_subscription? %>
                  <p class="text-xs text-blue-600 dark:text-blue-400 mb-2">ğŸ’ NecesitÄƒ abonament PRO (15 RON/lunÄƒ)</p>
                  <button type="button" 
                          onclick="createCheckoutSession(event)"
                          class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg text-sm font-medium transition-colors">
                    ğŸ¯ AboneazÄƒ-te acum
                  </button>
                <% else %>
                  <p class="text-xs text-gray-500 dark:text-gray-400">ğŸš§ ChatGPT este Ã®n curs de implementare!</p>
                <% end %>
              </div>
            </div>
          <% end %>
          
        <% when "generated_recipe" %>
          <!-- AI Generated Recipe -->
          <% if response["recipe"].present? %>
            <% recipe = response["recipe"] %>
            <div class="mt-4 bg-white dark:bg-gray-600 rounded-xl p-4 border-2 border-emerald-200 dark:border-emerald-700 shadow-lg">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-2xl">ğŸ½ï¸</span>
                <h3 class="font-bold text-lg text-gray-800 dark:text-white"><%= recipe["title"] %></h3>
              </div>
              
              <% if recipe["description"].present? %>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 italic"><%= recipe["description"] %></p>
              <% end %>
              
              <div class="grid grid-cols-4 gap-2 mb-4 text-xs">
                <div class="text-center p-2 bg-emerald-50 dark:bg-emerald-900/30 rounded-lg">
                  <span class="block text-lg mb-1">â±ï¸</span>
                  <span class="text-gray-700 dark:text-gray-200 font-semibold"><%= recipe["time_to_make"] %> min</span>
                </div>
                <div class="text-center p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                  <span class="block text-lg mb-1">ğŸ“Š</span>
                  <span class="text-gray-700 dark:text-gray-200 font-semibold">Nivel <%= recipe["difficulty"] %>/5</span>
                </div>
                <div class="text-center p-2 bg-green-50 dark:bg-green-900/30 rounded-lg">
                  <span class="block text-lg mb-1">ğŸ¥—</span>
                  <span class="text-gray-700 dark:text-gray-200 font-semibold">SÄƒnÄƒtos <%= recipe["healthiness"] %>/5</span>
                </div>
                <% if recipe["calories"].present? %>
                  <div class="text-center p-2 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                    <span class="block text-lg mb-1">ğŸ”¥</span>
                    <span class="text-gray-700 dark:text-gray-200 font-semibold"><%= recipe["calories"] %> cal</span>
                  </div>
                <% end %>
              </div>
              
              <% if recipe["servings"].present? %>
                <div class="mb-4 text-sm text-gray-600 dark:text-gray-300">
                  <span class="font-semibold">ğŸ‘¥ PorÈ›ii:</span> <%= recipe["servings"] %>
                </div>
              <% end %>
              
              <div class="space-y-3">
                <details class="group" open>
                  <summary class="cursor-pointer text-sm font-medium text-gray-700 dark:text-gray-200 flex items-center gap-2">
                    <svg class="w-4 h-4 transform group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    ğŸ¥• Ingrediente
                  </summary>
                  <div class="mt-2 pl-6 text-sm text-gray-600 dark:text-gray-300 whitespace-pre-line">
                    <%= recipe["ingredients"] %>
                  </div>
                </details>
                
                <details class="group">
                  <summary class="cursor-pointer text-sm font-medium text-gray-700 dark:text-gray-200 flex items-center gap-2">
                    <svg class="w-4 h-4 transform group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    ğŸ“ Mod de preparare
                  </summary>
                  <div class="mt-2 pl-6 text-sm text-gray-600 dark:text-gray-300 whitespace-pre-line">
                    <%= recipe["preparation"] %>
                  </div>
                </details>
                
                <% if recipe["tips"].present? %>
                  <details class="group mt-3">
                    <summary class="cursor-pointer text-sm font-medium text-gray-700 dark:text-gray-200 flex items-center gap-2">
                      <svg class="w-4 h-4 transform group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      ğŸ’¡ Sfaturi utile
                    </summary>
                    <div class="mt-2 pl-6 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg text-sm text-yellow-700 dark:text-yellow-300">
                      <%= recipe["tips"] %>
                    </div>
                  </details>
                <% end %>
                
                <% if recipe["additional_ingredients"].present? %>
                  <details class="group mt-3">
                    <summary class="cursor-pointer text-sm font-medium text-gray-700 dark:text-gray-200 flex items-center gap-2">
                      <svg class="w-4 h-4 transform group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      ğŸ›’ Ce ar mai trebui sÄƒ cumperi (opÈ›ional)
                    </summary>
                    <div class="mt-2 pl-6 text-sm text-gray-600 dark:text-gray-300 whitespace-pre-line">
                      <%= recipe["additional_ingredients"] %>
                    </div>
                  </details>
                <% end %>
              </div>
              
              <!-- Save Recipe Button -->
              <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-500">
                <button type="button" 
                        class="save-ai-recipe-btn w-full py-2 px-4 bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-700 hover:to-teal-600 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all text-sm"
                        data-recipe='<%= recipe.to_json %>'>
                  ğŸ’¾ SalveazÄƒ reÈ›eta Ã®n profilul meu
                </button>
              </div>
            </div>
          <% end %>
          
        <% when "insufficient_ingredients" %>
          <!-- Not enough ingredients -->
          <% if response["suggested_ingredients"].present? %>
            <div class="mt-3 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
              <p class="text-sm font-medium text-amber-700 dark:text-amber-300 mb-2">ğŸ›’ Ingrediente sugerate:</p>
              <div class="flex flex-wrap gap-2">
                <% response["suggested_ingredients"].each do |ing| %>
                  <span class="px-2 py-1 bg-amber-100 dark:bg-amber-800/30 text-amber-700 dark:text-amber-300 rounded-lg text-xs">
                    <%= ing %>
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <% if response["possible_recipes_with_additions"].present? %>
            <div class="mt-3">
              <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ’¡ Cu ingredientele sugerate ai putea face:</p>
              <ul class="list-disc list-inside text-sm text-gray-600 dark:text-gray-400 space-y-1">
                <% response["possible_recipes_with_additions"].each do |recipe_idea| %>
                  <li><%= recipe_idea %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
        <% when "need_clarification" %>
          <div class="mt-2 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm text-blue-600 dark:text-blue-400">
            ğŸ’¬ ÃncearcÄƒ sÄƒ formulezi diferit, de exemplu: "Am pui, cartofi È™i ceapÄƒ"
          </div>
          
        <% when "error" %>
          <div class="mt-2 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-sm text-red-600 dark:text-red-400">
            âš ï¸ <%= response["message"] %>
            <% if response["error"] %>
              <br><span class="text-xs opacity-75">Detalii: <%= response["error"] %></span>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <!-- Plain text response -->
      <p class="text-gray-800 dark:text-gray-200 text-sm leading-relaxed">
        <%= response %>
      </p>
    <% end %>
  </div>
</div>

<script>
// Handle save recipe button
document.addEventListener('click', function(e) {
  // Save recipe button
  if (e.target.classList.contains('save-ai-recipe-btn') || e.target.closest('.save-ai-recipe-btn')) {
    const btn = e.target.classList.contains('save-ai-recipe-btn') ? e.target : e.target.closest('.save-ai-recipe-btn');
    const recipeData = JSON.parse(btn.dataset.recipe);
    
    btn.disabled = true;
    btn.innerHTML = 'â³ Se salveazÄƒ...';
    
    fetch('<%= ai_assistant_save_recipe_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ recipe: recipeData })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        btn.innerHTML = 'âœ… SalvatÄƒ!';
        btn.classList.remove('from-emerald-600', 'to-teal-500');
        btn.classList.add('bg-green-500');
        
        setTimeout(() => {
          if (data.recipe_url) {
            window.location.href = data.recipe_url;
          }
        }, 1000);
      } else {
        btn.innerHTML = 'âŒ Eroare: ' + (data.errors ? data.errors.join(', ') : 'NecunoscutÄƒ');
        btn.disabled = false;
        setTimeout(() => {
          btn.innerHTML = 'ğŸ’¾ SalveazÄƒ reÈ›eta Ã®n profilul meu';
        }, 3000);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      btn.innerHTML = 'âŒ Eroare la salvare';
      btn.disabled = false;
    });
  }
  
  // Generate with AI button
  if (e.target.classList.contains('generate-ai-btn') || e.target.closest('.generate-ai-btn')) {
    const btn = e.target.classList.contains('generate-ai-btn') ? e.target : e.target.closest('.generate-ai-btn');
    const provider = btn.dataset.provider;
    const ingredients = JSON.parse(btn.dataset.ingredients);
    
    btn.disabled = true;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ Se genereazÄƒ...';
    
    // Submit a new message with the AI provider
    const input = document.getElementById('ai-message-input');
    const providerInput = document.getElementById('ai-provider-input');
    
    if (input && providerInput) {
      providerInput.value = provider;
      input.value = `GenereazÄƒ o reÈ›etÄƒ cu: ${ingredients.join(', ')}`;
      document.getElementById('ai-input-form').requestSubmit();
    }
    
    // Reset button after a delay
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 2000);
  }
});
</script>
