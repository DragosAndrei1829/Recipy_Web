<% content_for :title, "Chef AI - Asistent Culinar" %>

<div class="ai-assistant-container max-w-4xl mx-auto">
  <!-- Header -->
  <div class="ai-header bg-gradient-to-r from-emerald-600 to-teal-500 rounded-2xl p-6 mb-6 text-white shadow-xl">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
          <span class="text-4xl">ğŸ‘¨â€ğŸ³</span>
        </div>
        <div>
          <h1 class="text-2xl font-bold">Chef AI</h1>
          <p class="text-white/80">Spune-mi ce ingrediente ai È™i te ajut sÄƒ gÄƒteÈ™ti ceva delicios!</p>
        </div>
      </div>
      
      <!-- AI Provider Selector -->
      <div class="hidden sm:block">
        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-2">
          <label class="text-xs text-white/60 block mb-1 px-2">Motor AI:</label>
          <div class="flex gap-1" id="ai-provider-selector">
            <button type="button" 
                    class="provider-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all <%= @current_provider == 'local' ? 'bg-white text-emerald-600' : 'text-white/80 hover:bg-white/20' %>"
                    data-provider="local"
                    title="CÄƒutare Ã®n reÈ›ete existente (gratuit)">
              ğŸ” Local
            </button>
            <% if ENV['OPENAI_API_KEY'].blank? || !current_user.has_active_ai_chat_subscription? %>
              <button type="button" 
                      class="provider-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all opacity-50 cursor-not-allowed"
                      title="<%= ENV['OPENAI_API_KEY'].present? ? 'NecesitÄƒ abonament - 15 RON/lunÄƒ' : 'NecesitÄƒ OPENAI_API_KEY' %>"
                      onclick="createCheckoutSession(event)">
                âœ¨ OpenAI
              </button>
            <% else %>
              <button type="button" 
                      class="provider-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all <%= @current_provider == 'openai' ? 'bg-white text-emerald-600' : 'text-white/80 hover:bg-white/20' %>"
                      data-provider="openai"
                      title="Generare cu GPT-4 (premium)">
                âœ¨ OpenAI
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Info badges -->
    <div class="mt-4 flex flex-wrap gap-2 items-center">
      <span class="px-3 py-1 bg-white/20 rounded-full text-sm backdrop-blur-sm">ğŸ†“ CÄƒutare localÄƒ gratuitÄƒ</span>
      <% if current_user.has_active_ai_chat_subscription? %>
        <span class="px-3 py-1 bg-green-500/30 rounded-full text-sm backdrop-blur-sm border border-green-400/50">âœ¨ OpenAI Activ</span>
      <% else %>
        <span class="px-3 py-1 bg-white/20 rounded-full text-sm backdrop-blur-sm">âœ¨ OpenAI 15 RON/lunÄƒ</span>
        <button 
          onclick="createCheckoutSession(event)" 
          class="ml-2 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 text-sm">
          ğŸ¯ AboneazÄƒ-te acum
        </button>
      <% end %>
      <span class="px-3 py-1 bg-white/20 rounded-full text-sm backdrop-blur-sm">â±ï¸ GÄƒtit rapid</span>
      <span class="px-3 py-1 bg-white/20 rounded-full text-sm backdrop-blur-sm">ğŸŒ± Vegetarian/Vegan</span>
    </div>
    
    <!-- Mobile Provider Selector -->
    <div class="sm:hidden mt-4">
      <select id="ai-provider-mobile" class="w-full px-3 py-2 bg-white/20 backdrop-blur-sm rounded-lg text-white text-sm border border-white/30">
        <option value="local" <%= 'selected' if @current_provider == 'local' %>>ğŸ” Local (gratuit)</option>
        <option value="openai" <%= 'selected' if @current_provider == 'openai' %> <%= 'disabled' if ENV['OPENAI_API_KEY'].blank? || !current_user.has_active_ai_chat_subscription? %> onclick="<%= 'createCheckoutSession()' unless current_user.has_active_ai_chat_subscription? %>">âœ¨ OpenAI (premium - 15 RON/lunÄƒ)</option>
      </select>
    </div>
  </div>

  <!-- How it works -->
  <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border border-blue-100 dark:border-blue-800">
    <h3 class="font-semibold text-blue-800 dark:text-blue-300 mb-2">ğŸ”„ Cum funcÈ›ioneazÄƒ:</h3>
    <ol class="text-sm text-blue-700 dark:text-blue-400 space-y-1">
      <li><strong>1. Local (gratuit):</strong> CÄƒutÄƒm Ã®n reÈ›etele existente din comunitate</li>
      <li><strong>2. OpenAI (premium):</strong> Generare cu GPT-4 (necesitÄƒ abonament PRO - 15 RON/lunÄƒ)</li>
    </ol>
  </div>

  <!-- Chat Container -->
  <div class="ai-chat-container bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden border border-gray-100 dark:border-gray-700">
    <!-- Messages Area -->
    <div id="ai-messages" class="ai-messages p-6 space-y-4 min-h-[400px] max-h-[60vh] overflow-y-auto">
      <% if @conversation_history.empty? %>
        <!-- Welcome Message -->
        <div class="ai-welcome text-center py-8">
          <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-emerald-100 to-teal-100 dark:from-emerald-900/30 dark:to-teal-900/30 rounded-full flex items-center justify-center">
            <span class="text-4xl">ğŸ‘¨â€ğŸ³</span>
          </div>
          <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">BunÄƒ! Sunt Chef AI</h2>
          <p class="text-gray-600 dark:text-gray-400 max-w-md mx-auto">
            Spune-mi ce ingrediente ai Ã®n bucÄƒtÄƒrie È™i Ã®È›i voi cÄƒuta reÈ›ete potrivite sau Ã®È›i voi crea una nouÄƒ!
          </p>
          
          <!-- Provider Info -->
          <div class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-full text-sm">
            <span class="text-gray-500 dark:text-gray-400">Motor activ:</span>
            <span class="font-medium text-emerald-600 dark:text-emerald-400" id="current-provider-display">
              <%= case @current_provider
                  when 'local' then 'ğŸ” Local (gratuit)'
                  when 'openai' then 'âœ¨ OpenAI (premium)'
                  else 'ğŸ” Local (gratuit)'
                  end %>
            </span>
          </div>
          
          <!-- Quick Suggestions -->
          <div class="mt-6 flex flex-wrap justify-center gap-2">
            <button type="button" class="ai-suggestion-btn px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 rounded-xl text-sm text-gray-700 dark:text-gray-300 transition-colors" data-message="Am pui, roÈ™ii È™i usturoi. Ce pot gÄƒti?">
              ğŸ— Pui, roÈ™ii, usturoi
            </button>
            <button type="button" class="ai-suggestion-btn px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 rounded-xl text-sm text-gray-700 dark:text-gray-300 transition-colors" data-message="Vreau ceva sÄƒnÄƒtos cu legume, la cuptor">
              ğŸ¥— SÄƒnÄƒtos la cuptor
            </button>
            <button type="button" class="ai-suggestion-btn px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 rounded-xl text-sm text-gray-700 dark:text-gray-300 transition-colors" data-message="Am paste, brÃ¢nzÄƒ È™i ouÄƒ. Ceva rapid Ã®n 20 de minute">
              ğŸ Paste rapide
            </button>
            <button type="button" class="ai-suggestion-btn px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-emerald-100 dark:hover:bg-emerald-900/30 rounded-xl text-sm text-gray-700 dark:text-gray-300 transition-colors" data-message="Sunt vegetarian È™i am cartofi, ciuperci È™i smÃ¢ntÃ¢nÄƒ">
              ğŸŒ± Vegetarian
            </button>
          </div>
        </div>
      <% else %>
        <% @conversation_history.each do |msg| %>
          <% if msg[:role] == "user" %>
            <%= render "ai_assistant/user_message", message: msg[:content] %>
          <% else %>
            <%= render "ai_assistant/assistant_message", response: msg[:content] %>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <!-- Input Area -->
    <div class="ai-input-area border-t border-gray-100 dark:border-gray-700 p-4 bg-gray-50 dark:bg-gray-800/50">
      <%= render "ai_assistant/input_form", current_provider: @current_provider %>
    </div>
  </div>

  <!-- Actions -->
  <div class="mt-4 flex justify-between items-center">
    <%= link_to clear_ai_conversation_path, method: :delete, class: "text-sm text-gray-500 hover:text-red-500 transition-colors", data: { turbo_method: :delete, turbo_confirm: "EÈ™ti sigur cÄƒ vrei sÄƒ È™tergi conversaÈ›ia?" } do %>
      <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
      </svg>
      È˜terge conversaÈ›ia
    <% end %>
    
    <p class="text-xs text-gray-400">
      ğŸ†“ CÄƒutare localÄƒ gratuitÄƒ â€¢ âœ¨ OpenAI 15 RON/lunÄƒ (PRO)
    </p>
  </div>
  </div>
</div>

<style>
  .ai-messages::-webkit-scrollbar {
    width: 6px;
  }
  .ai-messages::-webkit-scrollbar-track {
    background: transparent;
  }
  .ai-messages::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
  }
  .ai-messages::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
  
  .provider-btn.active {
    background: white;
    color: #059669;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let currentProvider = '<%= @current_provider %>';
  
  // Handle provider selection (desktop)
  document.querySelectorAll('.provider-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      if (this.disabled) return;
      
      const provider = this.dataset.provider;
      setProvider(provider);
      
      // Update UI
      document.querySelectorAll('.provider-btn').forEach(b => {
        b.classList.remove('bg-white', 'text-emerald-600');
        b.classList.add('text-white/80');
      });
      this.classList.add('bg-white', 'text-emerald-600');
      this.classList.remove('text-white/80');
    });
  });
  
  // Handle provider selection (mobile)
  const mobileSelect = document.getElementById('ai-provider-mobile');
  if (mobileSelect) {
    mobileSelect.addEventListener('change', function() {
      setProvider(this.value);
    });
  }
  
  function setProvider(provider) {
    currentProvider = provider;
    
    // Update hidden input in form
    const providerInput = document.getElementById('ai-provider-input');
    if (providerInput) {
      providerInput.value = provider;
    }
    
    // Update display
    const display = document.getElementById('current-provider-display');
    if (display) {
      const labels = {
        'local': 'ğŸ” Local (gratuit)',
        'openai': 'âœ¨ OpenAI (premium)'
      };
      display.textContent = labels[provider] || provider;
    }
    
    // Save preference via AJAX
    fetch('<%= set_ai_provider_path rescue "#" %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ provider: provider })
    });
  }
  
  // Handle suggestion buttons
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('ai-suggestion-btn')) {
      const message = e.target.dataset.message;
      const input = document.getElementById('ai-message-input');
      if (input) {
        input.value = message;
        showLoadingBeforeSubmit();
        document.getElementById('ai-input-form').requestSubmit();
      }
    }
  });
  
  // Add loading indicator before form submit
  const form = document.getElementById('ai-input-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      showLoadingBeforeSubmit();
    });
  }
  
  function showLoadingBeforeSubmit() {
    const messageInput = document.getElementById('ai-message-input');
    let message = messageInput ? messageInput.value.trim() : '';
    const providerInput = document.getElementById('ai-provider-input');
    const provider = providerInput ? providerInput.value : 'local';
    
    if (!message) return;
    
    // Store message before clearing input (for form submission)
    const storedMessage = message;
    
    const messagesContainer = document.getElementById('ai-messages');
    if (!messagesContainer) return;
    
    // Add user message
    const userMessageHTML = `
      <div class="ai-message ai-message-user flex justify-end">
        <div class="max-w-[85%] bg-gradient-to-r from-emerald-600 to-teal-500 rounded-2xl rounded-br-md px-4 py-3 shadow-sm">
          <p class="text-white text-sm">${escapeHtml(storedMessage)}</p>
        </div>
      </div>
    `;
    messagesContainer.insertAdjacentHTML('beforeend', userMessageHTML);
    
    // Add loading indicator
    const providerLabel = provider === 'openai' ? 'âœ¨ OpenAI genereazÄƒ reÈ›eta...' : 
                         'ğŸ” Caut Ã®n reÈ›ete...';
    const timeEstimate = provider === 'openai' ? 
                        'Poate dura 10-30 secunde' : 'Un moment...';
    
    const loadingHTML = `
      <div id="ai-loading-indicator" class="ai-message ai-message-assistant flex justify-start">
        <div class="max-w-[85%] bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-bl-md px-4 py-3 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="relative w-8 h-8">
              <div class="absolute inset-0 border-4 border-emerald-200 dark:border-emerald-800 rounded-full"></div>
              <div class="absolute inset-0 border-4 border-t-emerald-600 dark:border-t-emerald-400 rounded-full animate-spin"></div>
            </div>
            <div class="flex-1">
              <p class="text-gray-800 dark:text-gray-200 text-sm font-medium mb-1">${providerLabel}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">${timeEstimate}</p>
              <div class="mt-3 w-full h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full animate-progress"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    messagesContainer.insertAdjacentHTML('beforeend', loadingHTML);
    
    // Don't clear input yet - let form submit with the value
    // Input will be cleared after successful submit
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Auto-scroll to bottom on new messages
  const observer = new MutationObserver(() => {
    const messages = document.getElementById('ai-messages');
    if (messages) {
      messages.scrollTop = messages.scrollHeight;
    }
  });
  
  const messagesContainer = document.getElementById('ai-messages');
  if (messagesContainer) {
    observer.observe(messagesContainer, { childList: true });
  }
});

// Function to create Stripe checkout session
async function createCheckoutSession(event) {
  try {
    const button = event ? event.target : document.querySelector('[onclick*="createCheckoutSession"]');
    if (button) {
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = 'Se Ã®ncarcÄƒ...';
    }
    
    // Get current locale from URL
    const locale = window.location.pathname.split('/')[1] || 'ro';
    const url = `/${locale}/stripe/create-checkout-session`;
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (!csrfToken) {
      alert('Eroare de securitate. Te rugÄƒm sÄƒ reÃ®mprospÄƒtezi pagina.');
      return;
    }
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken.content,
        'Accept': 'application/json'
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        priceId: '<%= ENV["STRIPE_PRICE_ID_AI_CHAT"] %>'
      })
    });

    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Eroare necunoscutÄƒ');
    }
    
    if (data.sessionId && data.url) {
      // Redirect to Stripe Checkout
      window.location.href = data.url;
    } else {
      throw new Error('RÄƒspuns invalid de la server');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('A apÄƒrut o eroare: ' + (error.message || 'Te rugÄƒm sÄƒ Ã®ncerci din nou.'));
    const button = event ? event.target : document.querySelector('[onclick*="createCheckoutSession"]');
    if (button) {
      button.disabled = false;
      button.textContent = button.textContent.includes('Se Ã®ncarcÄƒ') ? 'ğŸ¯ AboneazÄƒ-te acum' : button.textContent;
    }
  }
}
</script>
