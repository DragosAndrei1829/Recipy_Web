<!-- Modern Compact Recipe View -->
<div class="recipe-show-compact">
  <!-- Compact Header -->
  <div class="recipe-header-compact">
    <div class="flex items-center justify-between mb-6">
      <%= link_to recipes_path(locale: I18n.locale), class: "flex items-center gap-2 text-primary-content hover:text-primary transition-colors" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        <span class="font-semibold"><%= t('common.back', default: 'Înapoi') %></span>
      <% end %>
      
      <% if user_signed_in? && @recipe.user == current_user %>
        <%= link_to edit_recipe_path(@recipe, locale: I18n.locale), class: "flex items-center gap-2 px-4 py-2 rounded-lg bg-primary/10 text-primary hover:bg-primary/20 transition-all" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
          <span class="font-semibold"><%= t('common.edit', default: 'Editează') %></span>
        <% end %>
      <% end %>
    </div>

    <!-- Image -->
    <% if @recipe.photos.attached? && @recipe.photos.first.present? %>
      <% begin %>
        <div class="recipe-image-compact">
          <%= image_tag url_for(@recipe.photos.first), 
              alt: @recipe.title,
              class: "w-full h-full object-cover",
              style: "max-height: 500px; object-fit: cover;" %>
        </div>
      <% rescue => e %>
        <!-- Skip image section if error -->
        <% Rails.logger.error("Recipe show image error: #{e.message}") %>
      <% end %>
    <% end %>

    <!-- Title & Meta -->
    <div class="recipe-title-section">
      <h1 class="recipe-title-compact"><%= @recipe.title %></h1>
      
      <!-- Author & Stats -->
      <div class="flex items-center justify-between flex-wrap gap-4 mt-4">
        <%= link_to user_path(@recipe.user, locale: I18n.locale), class: "flex items-center gap-3 group" do %>
          <% if @recipe.user&.avatar&.attached? %>
            <%= image_tag url_for(@recipe.user.avatar), 
                class: "w-10 h-10 rounded-full object-cover ring-2 ring-primary/20 group-hover:ring-primary/50 transition-all",
                style: "width: 40px; height: 40px; object-fit: cover;" %>
          <% else %>
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white text-sm font-bold">
              <%= @recipe.user.username&.first&.upcase || 'U' %>
            </div>
          <% end %>
          <div>
            <p class="font-bold text-primary-content group-hover:text-primary transition-colors"><%= @recipe.user.username %></p>
            <p class="text-xs opacity-60"><%= time_ago_in_words(@recipe.created_at) %> <%= t('time.ago', default: 'ago') %></p>
          </div>
        <% end %>

        <!-- Quick Stats -->
        <div class="flex items-center gap-3">
          <% if @recipe.time_to_make && @recipe.time_to_make > 0 %>
            <span class="stat-chip">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <%= @recipe.time_to_make %> min
            </span>
          <% end %>
          <% if @recipe.difficulty && @recipe.difficulty > 0 %>
            <span class="stat-chip">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <%= @recipe.difficulty %>/5
            </span>
          <% end %>
          <span class="stat-chip">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
            </svg>
            <%= @recipe.likes_count %>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="recipe-content-compact">
    <!-- Action Buttons with Turbo -->
    <div id="<%= dom_id(@recipe, :actions_compact) %>" class="recipe-actions-compact">
      <% if user_signed_in? && @recipe.likes.exists?(user: current_user) %>
        <%= button_to recipe_like_path(@recipe, locale: I18n.locale), method: :delete, id: "recipe_#{@recipe.id}_like_button", class: "action-btn-compact action-btn-compact--liked", form: { data: { turbo: true, turbo_stream: true } } do %>
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
          </svg>
          <span class="recipe-card-modern__action-count"><%= @recipe.likes_count %></span>
        <% end %>
      <% else %>
        <%= button_to recipe_like_path(@recipe, locale: I18n.locale), method: :post, id: "recipe_#{@recipe.id}_like_button", class: "action-btn-compact", form: { data: { turbo: true, turbo_stream: true } } do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
          </svg>
          <span class="recipe-card-modern__action-count"><%= @recipe.likes_count %></span>
        <% end %>
      <% end %>

      <button type="button" class="action-btn-compact" onclick="document.querySelector('#comments').scrollIntoView({ behavior: 'smooth' })">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        <span id="recipe_<%= @recipe.id %>_comment_count"><%= @recipe.comments_count %></span>
      </button>

      <% if user_signed_in? && @recipe.favorites.exists?(user: current_user) %>
        <%= button_to recipe_favorite_path(@recipe, locale: I18n.locale), method: :delete, id: "recipe_#{@recipe.id}_favorite_button", class: "action-btn-compact action-btn-compact--favorited", form: { data: { turbo: true, turbo_stream: true } } do %>
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
          </svg>
        <% end %>
      <% else %>
        <%= button_to recipe_favorite_path(@recipe, locale: I18n.locale), method: :post, id: "recipe_#{@recipe.id}_favorite_button", class: "action-btn-compact", form: { data: { turbo: true, turbo_stream: true } } do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
          </svg>
        <% end %>
      <% end %>
    </div>

    <!-- Description -->
    <% if @recipe.description.present? %>
      <div class="recipe-description-compact">
        <%= simple_format(@recipe.description) %>
      </div>
    <% end %>

    <!-- Two Column Layout -->
    <div class="recipe-columns-compact">
      <!-- Ingredients -->
      <div class="recipe-section-compact">
        <h2 class="section-title-compact">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <%= t('recipes.ingredients', default: 'Ingrediente') %>
        </h2>
        <ul class="ingredients-list-compact">
          <% @recipe.ingredients.split("\n").reject(&:blank?).each do |ingredient| %>
            <li class="ingredient-item-compact">
              <svg class="w-4 h-4 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              <span><%= ingredient.strip %></span>
            </li>
          <% end %>
        </ul>
      </div>

      <!-- Preparation -->
      <div class="recipe-section-compact">
        <h2 class="section-title-compact">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
          </svg>
          <%= t('recipes.preparation', default: 'Mod de preparare') %>
        </h2>
        <ol class="steps-list-compact">
          <% @recipe.preparation.split("\n").reject(&:blank?).each_with_index do |step, index| %>
            <li class="step-item-compact">
              <span class="step-number-compact"><%= index + 1 %></span>
              <span class="step-text-compact"><%= step.strip %></span>
            </li>
          <% end %>
        </ol>
      </div>
    </div>

    <!-- Comments Section -->
    <div id="comments" class="recipe-section-compact">
      <h2 class="section-title-compact">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        <%= t('comments.title', default: 'Comentarii') %> (<span id="recipe_<%= @recipe.id %>_comment_count"><%= @recipe.comments_count %></span>)
      </h2>
      
      <div id="<%= dom_id(@recipe, :comments) %>">
        <!-- Comment Form -->
        <% if user_signed_in? %>
          <div class="comment-form-compact">
            <%= form_with model: [@recipe, Comment.new], url: recipe_comments_path(@recipe, locale: I18n.locale), class: "space-y-3" do |f| %>
              <%= f.text_area :body, rows: 3, placeholder: t('comments.add_comment', default: 'Adaugă un comentariu...'), 
                  class: "w-full px-4 py-3 rounded-xl border-2 border-default focus:border-primary focus:ring-2 focus:ring-primary/20 bg-card text-primary-content resize-none transition-all" %>
              
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold text-secondary-content"><%= t('comments.rating', default: 'Rating:') %></span>
                  <div class="flex gap-1">
                    <% (1..5).each do |i| %>
                      <button type="button" class="rating-star" data-rating="<%= i %>">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                      </button>
                    <% end %>
                  </div>
                  <%= f.hidden_field :rating, id: 'comment-rating-input' %>
                </div>
                <%= f.submit t('comments.submit', default: 'Comentează'), class: "px-6 py-2 rounded-lg bg-gradient-to-r from-primary to-secondary text-white font-bold hover:shadow-lg transition-all" %>
              </div>
            <% end %>
          </div>
        <% end %>

        <!-- Comments List -->
        <div id="recipe_<%= @recipe.id %>_comments_list" class="comments-list-compact">
          <% @recipe.comments.order(created_at: :desc).each do |comment| %>
            <div id="comment_<%= comment.id %>" class="comment-item-compact">
              <div class="flex items-start gap-3">
                <%= link_to user_path(comment.user, locale: I18n.locale) do %>
                  <% if comment.user&.avatar&.attached? %>
                    <%= image_tag url_for(comment.user.avatar.variant(resize_to_fill: [32, 32])), 
                        class: "w-8 h-8 rounded-full object-cover" %>
                  <% else %>
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white text-xs font-bold">
                      <%= comment.user.username&.first&.upcase || 'U' %>
                    </div>
                  <% end %>
                <% end %>
                
                <div class="flex-1">
                  <div class="flex items-center justify-between gap-2 mb-1">
                    <div>
                      <%= link_to comment.user.username, user_path(comment.user, locale: I18n.locale), class: "font-bold text-primary-content hover:text-primary transition-colors" %>
                      <% if comment.rating %>
                        <span class="ml-2 inline-flex items-center gap-1 text-xs font-semibold text-accent">
                          <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                          </svg>
                          <%= comment.rating %>/5
                        </span>
                      <% end %>
                    </div>
                    <span class="text-xs opacity-60"><%= time_ago_in_words(comment.created_at) %> <%= t('time.ago', default: 'ago') %></span>
                  </div>
                  <p class="text-sm text-secondary-content"><%= comment.body %></p>
                  
                  <% if user_signed_in? && (comment.user == current_user || @recipe.user == current_user) %>
                    <div class="mt-2">
                      <%= button_to recipe_comment_path(@recipe, comment, locale: I18n.locale), method: :delete, class: "text-xs text-error hover:underline", 
                          data: { confirm: t('comments.confirm_delete', default: 'Ești sigur?') } do %>
                        <%= t('common.delete', default: 'Șterge') %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Rating stars interaction
document.querySelectorAll('.rating-star').forEach(star => {
  star.addEventListener('click', function() {
    const rating = parseInt(this.dataset.rating);
    document.getElementById('comment-rating-input').value = rating;
    
    // Update visual state
    document.querySelectorAll('.rating-star').forEach((s, i) => {
      const svg = s.querySelector('svg');
      if (i < rating) {
        svg.setAttribute('fill', 'currentColor');
        svg.setAttribute('stroke', 'none');
        s.classList.add('text-accent');
      } else {
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        s.classList.remove('text-accent');
      }
    });
  });
});
</script>
