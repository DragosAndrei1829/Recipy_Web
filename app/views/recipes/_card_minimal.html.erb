<% 
  # Get valid photo (cover or first photo)
  begin
    has_cover = recipe.cover_photo&.attached?
    has_photos = recipe.photos.attached?
    
    first_valid_photo = nil
    if has_photos
      first_valid_photo = recipe.photos.detect { |p| p.persisted? && p.blob.present? }
    end
  rescue
    has_cover = false
    has_photos = false
    first_valid_photo = nil
  end
  
  valid_photo = has_cover ? recipe.cover_photo : first_valid_photo
%>

<article id="<%= dom_id(recipe) %>" class="flex w-full flex-col items-start gap-4 rounded-md border border-neutral-300 dark:border-gray-700 bg-card px-6 py-6 shadow-sm hover:shadow-md transition-all duration-200">
  <!-- Header: Avatar + Username + Time + More -->
  <div class="flex w-full items-center gap-3">
    <% if recipe.user.avatar&.attached? %>
      <% begin %>
        <%= image_tag url_for(recipe.user.avatar.variant(resize_to_fill: [40,40])), 
            class: "w-10 h-10 rounded-full object-cover" %>
      <% rescue ActiveStorage::FileNotFoundError %>
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white font-bold">
          <%= recipe.user.username&.first&.upcase || 'U' %>
        </div>
      <% end %>
    <% else %>
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white font-bold">
        <%= recipe.user.username&.first&.upcase || 'U' %>
      </div>
    <% end %>
    
    <div class="flex grow flex-col items-start">
      <%= link_to recipe.user.username, user_path(recipe.user, locale: I18n.locale), class: "text-base font-bold text-primary-content hover:text-primary transition-colors" %>
      <span class="text-sm text-secondary-content">
        @<%= recipe.user.username %> Â· <%= time_ago_in_words(recipe.created_at) %>
      </span>
    </div>
    
    <% if user_signed_in? && current_user == recipe.user %>
      <%= link_to edit_recipe_path(recipe, locale: I18n.locale), class: "w-8 h-8 flex items-center justify-center rounded-md text-secondary-content hover:bg-neutral-100 dark:hover:bg-gray-800 transition-colors" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
        </svg>
      <% end %>
    <% end %>
  </div>

  <!-- Title -->
  <%= link_to recipe_path(recipe, locale: I18n.locale), class: "w-full group" do %>
    <h3 class="text-lg font-bold text-primary-content group-hover:text-primary transition-colors">
      <%= recipe.title %>
    </h3>
  <% end %>
  
  <!-- Description (if present) -->
  <% if recipe.description.present? %>
    <p class="w-full text-base text-primary-content line-clamp-3">
      <%= recipe.description %>
    </p>
  <% end %>

  <!-- Image (if exists and accessible) -->
  <% if valid_photo %>
    <% begin %>
      <%= link_to recipe_path(recipe, locale: I18n.locale), class: "w-full group" do %>
        <%= image_tag url_for(valid_photo.variant(resize_to_fill: [800, 400])), 
            class: "h-80 w-full rounded-md object-cover group-hover:opacity-95 transition-opacity duration-200 cursor-pointer",
            loading: "lazy" %>
      <% end %>
    <% rescue ActiveStorage::FileNotFoundError, NoMethodError %>
      <!-- Skip image if not found -->
    <% end %>
  <% end %>

  <!-- Badges - Max 3 -->
  <div class="flex w-full items-center gap-2 flex-wrap">
    <% if recipe.category %>
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border border-neutral-300 dark:border-gray-700 bg-neutral-50 dark:bg-gray-800 text-secondary-content">
        <%= recipe.category.display_name %>
      </span>
    <% end %>
    <% if recipe.cuisine %>
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border border-neutral-300 dark:border-gray-700 bg-neutral-50 dark:bg-gray-800 text-secondary-content">
        <%= recipe.cuisine.display_name %>
      </span>
    <% end %>
    <% if recipe.time_to_make && recipe.time_to_make > 0 %>
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border border-neutral-300 dark:border-gray-700 bg-neutral-50 dark:bg-gray-800 text-secondary-content">
        <%= recipe.time_to_make %> min
      </span>
    <% end %>
  </div>

  <!-- Actions - Simple Icons -->
  <div class="flex w-full items-center justify-between border-t border-neutral-border dark:border-gray-700 pt-4">
    <div class="flex items-center gap-6">
      <!-- Like -->
      <%= button_to recipe_like_path(recipe, locale: I18n.locale),
          method: :post,
          class: "flex items-center gap-2 text-secondary-content hover:text-rose-500 transition-colors duration-200 cursor-pointer border-0 bg-transparent p-0",
          data: { turbo: false },
          form: { style: "display: inline;" } do %>
        <svg class="w-5 h-5 <%= 'text-rose-500 fill-rose-500' if user_signed_in? && recipe.likes.exists?(user: current_user) %>" 
             fill="<%= user_signed_in? && recipe.likes.exists?(user: current_user) ? 'currentColor' : 'none' %>" 
             stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
        <span class="text-sm font-medium"><%= recipe.likes_count %></span>
      <% end %>

      <!-- Comment -->
      <%= link_to recipe_path(recipe, anchor: "comments", locale: I18n.locale),
          class: "flex items-center gap-2 text-secondary-content hover:text-blue-500 transition-colors duration-200 cursor-pointer" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        <span class="text-sm font-medium"><%= recipe.comments_count %></span>
      <% end %>

      <!-- Share -->
      <button type="button" class="flex items-center gap-2 text-secondary-content hover:text-primary transition-colors duration-200 cursor-pointer"
              onclick="navigator.share({title: '<%= recipe.title.gsub("'", "\\\\'") %>', url: '<%= recipe_url(recipe, locale: I18n.locale) %>'}).catch(() => {})">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
        </svg>
        <span class="text-sm font-medium">Share</span>
      </button>
    </div>

    <!-- Bookmark -->
    <% if user_signed_in? %>
      <%= button_to recipe_favorite_path(recipe, locale: I18n.locale),
          method: :post,
          class: "w-8 h-8 flex items-center justify-center rounded-md text-secondary-content hover:text-amber-500 hover:bg-neutral-100 dark:hover:bg-gray-800 transition-colors border-0 bg-transparent",
          data: { turbo: false },
          form: { style: "display: inline;" } do %>
        <svg class="w-5 h-5 <%= 'text-amber-500 fill-amber-500' if recipe.favorites.exists?(user: current_user) %>" 
             fill="<%= recipe.favorites.exists?(user: current_user) ? 'currentColor' : 'none' %>" 
             stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
        </svg>
      <% end %>
    <% end %>
  </div>
</article>

