<% rating_scope = recipe.comments.where.not(rating: nil) %>
<% avg_rating = rating_scope.any? ? rating_scope.average(:rating).to_f.round(1) : nil %>

<article class="feed-card relative">
  <%# Report Flag - Top Right Corner %>
  <% if user_signed_in? && recipe.user != current_user %>
    <% already_reported = recipe.reports.exists?(reporter: current_user) %>
    <div class="absolute top-2 right-2 z-10">
      <% if already_reported %>
        <span class="flex items-center justify-center w-8 h-8 bg-orange-100 dark:bg-orange-900/30 rounded-lg" title="Ai raportat această rețetă">
          <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
            <path d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
          </svg>
        </span>
      <% else %>
        <button type="button" 
                onclick="openReportModal('recipe', '<%= recipe.id %>')"
                class="flex items-center justify-center w-8 h-8 bg-gray-100/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-lg text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 transition-all"
                title="Raportează">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
          </svg>
        </button>
      <% end %>
    </div>
  <% end %>

  <header class="feed-card__header">
    <% if recipe.user %>
      <%= link_to user_path(recipe.user), data: { turbo_frame: "_top" }, class: "feed-card__author" do %>
        <% if recipe.user.avatar&.attached? %>
          <%= image_tag url_for(recipe.user.avatar.variant(resize_to_fill: [44,44])), class: "feed-card__avatar" %>
        <% else %>
          <div class="feed-card__avatar placeholder">
            <svg class="h-5 w-5 text-secondary-content" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          </div>
        <% end %>
        <div class="min-w-0">
          <p class="feed-card__timestamp"><%= time_ago_in_words(recipe.created_at) %> <%= t('time.ago') %></p>
          <p class="feed-card__author-name truncate"><%= recipe.user.username || recipe.user.email || "Anonim" %></p>
        </div>
      <% end %>
    <% else %>
      <div class="feed-card__author">
        <div class="feed-card__avatar placeholder">
          <svg class="h-5 w-5 text-secondary-content" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        </div>
        <div>
          <p class="feed-card__timestamp"><%= time_ago_in_words(recipe.created_at) %> <%= t('time.ago') %></p>
          <p class="feed-card__author-name">Anonim</p>
        </div>
      </div>
    <% end %>
    <div class="feed-card__badges">
      <% if recipe.category %>
        <span><%= recipe.category&.display_name %></span>
      <% end %>
      <% if recipe.cuisine %>
        <span><%= recipe.cuisine&.display_name %></span>
      <% end %>
    </div>
  </header>

  <% 
    # Check for valid image - verify file exists in storage
    begin
      has_cover = recipe.cover_photo.present? && recipe.cover_photo.blob&.service&.exist?(recipe.cover_photo.blob.key)
    rescue
      has_cover = false
    end
    begin
      if !has_cover && recipe.photos.attached?
        first_valid_photo = recipe.photos.find { |p| p.blob&.service&.exist?(p.blob.key) rescue false }
      else
        first_valid_photo = nil
      end
    rescue
      first_valid_photo = nil
    end
    valid_photo = has_cover ? recipe.cover_photo : first_valid_photo
  %>
  <% if valid_photo %>
    <div class="feed-card__media">
      <%= image_tag url_for(valid_photo.variant(resize_to_fill: [1000,560])), class: "feed-card__cover" %>
    </div>
  <% end %>

  <div class="feed-card__body">
    <div class="feed-card__title">
      <h2><%= recipe.title %></h2>
      <p><%= truncate(recipe.description.presence || 'Fără descriere', length: 140) %></p>
    </div>

    <div class="feed-card__stats">
      <% if recipe.time_to_make.present? && recipe.time_to_make.positive? %>
        <span class="stat-chip">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <%= recipe.time_to_make %> min
        </span>
      <% end %>
      <% if recipe.difficulty.present? && recipe.difficulty.positive? %>
        <span class="stat-chip">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17l-5 3 1.5-5.5L4 10h5l2-6 2 6h5l-4.5 4.5L17 20z"/></svg>
          <%= recipe.difficulty %>/5
        </span>
      <% end %>
      <% if recipe.healthiness.present? && recipe.healthiness.positive? %>
        <span class="stat-chip">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m0 0l3-3m-3 3l-3-3"/></svg>
          <%= recipe.healthiness %>/5
        </span>
      <% end %>
      <% if avg_rating %>
        <span class="stat-chip">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.039 3.19a1 1 0 00.95.69h3.356c.969 0 1.371 1.24.588 1.81l-2.715 1.972a1 1 0 00-.364 1.118l1.038 3.19c.3.921-.755 1.688-1.54 1.118l-2.715-1.972a1 1 0 00-1.176 0l-2.715 1.972c-.785.57-1.84-.197-1.54-1.118l1.038-3.19a1 1 0 00-.364-1.118L4.117 8.617c-.783-.57-.38-1.81.588-1.81h3.356a1 1 0 00.95-.69l1.038-3.19z"/></svg>
          <%= avg_rating %>/10
        </span>
      <% end %>
    </div>

    <%# Compact Actions Row %>
    <div class="flex items-center justify-between gap-2 pt-3 border-t border-gray-100 dark:border-gray-800">
      <%# Left side - Interaction buttons %>
      <div class="flex items-center gap-1">
        <% if user_signed_in? %>
          <% liked = recipe.likes.exists?(user: current_user) %>
          <% favorited = current_user.favorites.exists?(recipe: recipe) %>

          <%# Like Button - Icon + Count %>
          <%= form_with url: recipe_like_path(recipe, format: :turbo_stream),
                        method: liked ? :delete : :post, data: { turbo: true }, class: "inline" do %>
            <button type="submit"
                    class="flex items-center gap-1 px-2 py-1.5 rounded-lg text-sm font-medium transition-all <%= liked ? 'text-rose-500 bg-rose-50 dark:bg-rose-900/20' : 'text-gray-500 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20' %>"
                    title="<%= liked ? 'Nu mai aprecia' : 'Apreciază' %>">
              <svg class="w-5 h-5" fill="<%= liked ? 'currentColor' : 'none' %>" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
              <span class="text-xs font-bold"><%= defined?(recipe.likes_count) ? recipe.likes_count : recipe.likes.count %></span>
            </button>
          <% end %>

          <%# Comments - Icon + Count (toggle inline comments) %>
          <button type="button"
                  onclick="toggleInlineComments('<%= recipe.id %>')"
                  class="flex items-center gap-1 px-2 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 transition-all"
                  title="Comentarii">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <span class="text-xs font-bold"><%= defined?(recipe.comments_count) ? recipe.comments_count : recipe.comments.count %></span>
          </button>

          <%# Save/Favorite Button - Icon only %>
          <%= form_with url: recipe_favorite_path(recipe, format: :turbo_stream),
                        method: favorited ? :delete : :post, data: { turbo: true }, class: "inline" do %>
            <button type="submit"
                    class="flex items-center justify-center w-8 h-8 rounded-lg transition-all <%= favorited ? 'text-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'text-gray-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20' %>"
                    title="<%= favorited ? 'Elimină din salvate' : 'Salvează' %>">
              <svg class="w-5 h-5" fill="<%= favorited ? 'currentColor' : 'none' %>" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
              </svg>
            </button>
          <% end %>
        <% else %>
          <%# Not logged in - show counts only %>
          <span class="flex items-center gap-1 px-2 py-1.5 text-gray-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            <span class="text-xs font-bold"><%= defined?(recipe.likes_count) ? recipe.likes_count : recipe.likes.count %></span>
          </span>
          <span class="flex items-center gap-1 px-2 py-1.5 text-gray-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
            <span class="text-xs font-bold"><%= defined?(recipe.comments_count) ? recipe.comments_count : recipe.comments.count %></span>
          </span>
        <% end %>
      </div>

      <%# Right side - View Recipe button %>
      <%= link_to recipe_path(recipe), data: { turbo_frame: "_top" }, class: "flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white text-sm font-semibold rounded-lg shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>
        <span><%= t('card.view_recipe', default: 'Vezi') %></span>
      <% end %>
    </div>

    <%# Inline Comments Section (hidden by default) %>
    <div id="inline-comments-<%= recipe.id %>" class="hidden mt-3 pt-3 border-t border-gray-100 dark:border-gray-800">
      <%# Recent comments preview %>
      <% recent_comments = recipe.comments.includes(:user).order(created_at: :desc).limit(2) %>
      <% if recent_comments.any? %>
        <div class="space-y-2 mb-3">
          <% recent_comments.each do |comment| %>
            <div class="flex items-start gap-2">
              <% if comment.user&.avatar&.attached? %>
                <%= image_tag url_for(comment.user.avatar.variant(resize_to_fill: [24,24])), class: "w-6 h-6 rounded-full flex-shrink-0" %>
              <% else %>
                <div class="w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center flex-shrink-0">
                  <span class="text-[10px] font-bold text-gray-500"><%= comment.user&.username&.first&.upcase || 'U' %></span>
                </div>
              <% end %>
              <div class="flex-1 min-w-0">
                <p class="text-xs">
                  <span class="font-semibold text-gray-900 dark:text-white"><%= comment.user&.username || 'Anonim' %></span>
                  <span class="text-gray-600 dark:text-gray-400 ml-1"><%= truncate(comment.content, length: 80) %></span>
                </p>
              </div>
            </div>
          <% end %>
        </div>
        <% if recipe.comments.count > 2 %>
          <%= link_to recipe_path(recipe, anchor: 'comments'), 
                      class: "text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 mb-2 block",
                      data: { turbo_frame: "_top" } do %>
            Vezi toate cele <%= recipe.comments.count %> comentarii →
          <% end %>
        <% end %>
      <% end %>

      <%# Quick comment form %>
      <% if user_signed_in? %>
        <%= form_with url: recipe_comments_path(recipe), method: :post, 
                      data: { turbo_frame: "inline-comments-#{recipe.id}" },
                      class: "flex items-center gap-2" do |f| %>
          <% if current_user.avatar&.attached? %>
            <%= image_tag url_for(current_user.avatar.variant(resize_to_fill: [28,28])), class: "w-7 h-7 rounded-full flex-shrink-0" %>
          <% else %>
            <div class="w-7 h-7 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center flex-shrink-0">
              <span class="text-xs font-bold text-white"><%= current_user.username&.first&.upcase || 'U' %></span>
            </div>
          <% end %>
          <%= f.text_field :content, 
                           placeholder: "Scrie un comentariu...",
                           class: "flex-1 px-3 py-2 text-sm bg-gray-100 dark:bg-gray-800 border-0 rounded-full focus:ring-2 focus:ring-emerald-500/30 focus:bg-white dark:focus:bg-gray-700 transition-all",
                           autocomplete: "off" %>
          <button type="submit" class="p-2 text-emerald-500 hover:text-emerald-600 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 rounded-full transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
          </button>
        <% end %>
      <% else %>
        <%= link_to new_user_session_path, class: "flex items-center gap-2 text-sm text-gray-500 hover:text-emerald-500" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
          </svg>
          Conectează-te pentru a comenta
        <% end %>
      <% end %>
    </div>
  </div>
</article>

<script>
function toggleInlineComments(recipeId) {
  const section = document.getElementById('inline-comments-' + recipeId);
  if (section) {
    section.classList.toggle('hidden');
    // Focus on input if opened
    if (!section.classList.contains('hidden')) {
      const input = section.querySelector('input[name="content"]');
      if (input) input.focus();
    }
  }
}
</script>
